# Docker Compose for GraphHopper + Jadlo
#
# This sets up GraphHopper routing engine alongside Jadlo.
# GraphHopper provides production-ready routing with:
# - 500-1000x faster queries than OSMnx
# - 30x less memory usage
# - No API rate limits
#
# Usage:
#   docker-compose -f docker-compose.graphhopper.yml up -d
#
# After startup:
#   - GraphHopper API: http://localhost:8989
#   - Jadlo API: http://localhost:8000
#

version: '3.8'

services:
  graphhopper:
    image: graphhopper/graphhopper:latest
    container_name: jadlo-graphhopper
    ports:
      - "8989:8989"
    volumes:
      - ./graphhopper-data:/data
    environment:
      - JAVA_OPTS=-Xmx1g -Xms512m
    command: >
      --input /data/poland-latest.osm.pbf
      --graph.location /data/graph-cache
      --graph.flag_encoders bike,mtb
      --host 0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - jadlo-network

  jadlo:
    build: .
    container_name: jadlo-app
    ports:
      - "8000:8000"
    environment:
      - ROUTING_BACKEND=auto
      - GRAPHHOPPER_URL=http://graphhopper:8989
    depends_on:
      graphhopper:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - jadlo-network

networks:
  jadlo-network:
    driver: bridge

volumes:
  graphhopper-data:
