name: Route Quality Check

on:
  push:
    branches:
      - main
      - 'copilot/**'
  pull_request:
    branches:
      - main

jobs:
  test-route-quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        test:
          - name: "30km route performance"
            test_path: "tests/test_integration_requirements.py::test_30km_route_performance"
            timeout: 15
            description: "Performance test - 30km route generation"
          - name: "60km route performance"
            test_path: "tests/test_integration_requirements.py::test_60km_route_performance"
            timeout: 20
            description: "Performance test - 60km route generation"
          - name: "100km route performance"
            test_path: "tests/test_integration_requirements.py::test_100km_route_performance"
            timeout: 25
            description: "Performance test - 100km route generation"
          - name: "100km route gap quality"
            test_path: "tests/test_integration_requirements.py::test_100km_route_no_large_gaps"
            timeout: 25
            description: "Quality test - Check for gaps in 100km route"
          - name: "Paved surface preference"
            test_path: "tests/test_integration_requirements.py::test_100km_route_paved_surface_preference"
            timeout: 15
            description: "Surface preference test - Paved surface routing"
    
    name: ${{ matrix.test.description }}
    timeout-minutes: ${{ matrix.test.timeout }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgeos-dev libproj-dev libgdal-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run test - ${{ matrix.test.name }}
      run: |
        PYTHONPATH=. python -m pytest ${{ matrix.test.test_path }} -v -s --tb=short
      env:
        PYTHONDONTWRITEBYTECODE: 1
    
    - name: Test result summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "## ✅ ${{ matrix.test.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ ${{ matrix.test.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test failed. Please review the output above for details." >> $GITHUB_STEP_SUMMARY
        fi
